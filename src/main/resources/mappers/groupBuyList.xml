<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oopsw.matna.dao.GroupBuyListDAO">
    <select id="getParticipantList" parameterType="java.lang.Integer" resultType="com.oopsw.matna.vo.GroupBuyListVO">
        SELECT
        pgb.period_group_buy_no         AS periodGroupBuyNo,
        qgb.quantity_group_buy_no         AS quantityGroupBuyNo,
        gb.group_buy_no          AS groupBuyNo,
        gbp.group_participant_no AS groupParticipantNo,
        gb.title,
        gb.status,
        gb.image_url             AS imageUrl,
        gb.unit                  AS unit,
        gb.in_date               AS inDate,
        gb.buy_end_date          AS buyEndDate,
        gb.share_end_date        AS shareEndDate,
        gb.buy_date              AS buyDate,
        gb.arrival_date          AS arrivalDate,
        gbp.receive_date         AS receiveDate,
        gb.payment_note          AS paymentNote,

        /* VO에 추가된 이미지 필드 매핑 */
        gb.arrival_image_url     AS arrivalImageUrl,
        gb.receipt_image_url     AS receiptImageUrl,

        /* 기간 공구 마감일 (기간 공구 테이블 조인 필요) */
        pgb.due_date             AS DueDate,

        /* 남은 수량 계산 */
        CASE
        WHEN gb.quantity > 0 THEN
        gb.quantity - (COALESCE(total_participant.total_qty, 0))
        ELSE 0
        END                      AS remainingQuantity,

        gbp.my_quantity          AS myQuantity,
        gbp.participated_date    AS participatedDate,
        gbp.final_payment_point  AS finalPaymentPoint,

        /* 나를 제외한 참여자 수: 전체 - 1 */
        (COALESCE(total_participant.total_count, 0) - 1) AS participantExMe,

        0                        AS totalSettlementPoint

        FROM
        group_buy_participant gbp
        JOIN group_buys gb ON gbp.group_buy_no = gb.group_buy_no

        /* 기간 공구 정보 조인 (DueDate) */
        LEFT JOIN period_group_buys pgb ON gb.group_buy_no = pgb.group_buy_no

        /* 전체 통계용 서브쿼리 */
        LEFT JOIN
        (SELECT
        sub_gbp.group_buy_no,
        SUM(sub_gbp.my_quantity) AS total_qty,
        COUNT(sub_gbp.participant_no) AS total_count
        FROM
        group_buy_participant sub_gbp
        GROUP BY
        sub_gbp.group_buy_no
        ) total_participant ON gb.group_buy_no = total_participant.group_buy_no

        LEFT JOIN
        quantity_group_buys qgb ON gb.group_buy_no = qgb.group_buy_no

        WHERE
        gbp.participant_no = #{participantNo} AND
        gbp.cancel_date IS NULL

        <if test="filter != null and filter != 'ALL'">
            AND gb.status = #{filter}
        </if>

        ORDER BY
        gbp.participated_date DESC
    </select>

    <select id="getHostList" parameterType="java.lang.Integer" resultType="com.oopsw.matna.vo.GroupBuyListVO">
        SELECT
        pgb.period_group_buy_no         AS periodGroupBuyNo,
        qgb.quantity_group_buy_no         AS quantityGroupBuyNo,
        gb.group_buy_no          AS groupBuyNo,
        gb.title,
        gb.status,
        gb.image_url             AS imageUrl,
        gb.unit                  AS unit,
        gb.in_date               AS inDate,
        gb.buy_end_date          AS buyEndDate,
        gb.share_end_date        AS shareEndDate,
        gb.buy_date              AS buyDate,
        gb.arrival_date          AS arrivalDate,
        gb.payment_note          AS paymentNote,

        /* VO에 추가된 이미지 필드 매핑 */
        gb.arrival_image_url     AS arrivalImageUrl,
        gb.receipt_image_url     AS receiptImageUrl,

        /* 기간 공구 마감일 */
        pgb.due_date             AS DueDate,

        /* 남은 수량 계산 */
        CASE
        WHEN gb.quantity > 0 THEN
        gb.quantity - COALESCE(total_participant.total_qty, 0)
        ELSE 0
        END                      AS remainingQuantity,

        /* 내 수량이 없으면 0으로 표시 */
        COALESCE(gbp.my_quantity, 0) AS myQuantity,

        gbp.participated_date    AS participatedDate,
        gbp.final_payment_point  AS finalPaymentPoint,

        /* 나를 제외한 참여자 수 계산 (내가 참여 안 했으면 전체, 했으면 -1) */
        CASE
        WHEN gbp.participant_no IS NOT NULL THEN (COALESCE(total_participant.total_count, 0) - 1)
        ELSE COALESCE(total_participant.total_count, 0)
        END                      AS participantExMe,

        0                        AS totalSettlementPoint

        FROM
        group_buys gb

        LEFT JOIN
        group_buy_participant gbp
        ON gb.group_buy_no = gbp.group_buy_no
        AND gbp.participant_no = #{memberNo}

        /* 기간 공구 정보 조인 (DueDate) */
        LEFT JOIN period_group_buys pgb ON gb.group_buy_no = pgb.group_buy_no

        /* 전체 통계용 서브쿼리 */
        LEFT JOIN
        (SELECT
        sub_gbp.group_buy_no,
        SUM(sub_gbp.my_quantity) AS total_qty,
        COUNT(sub_gbp.participant_no) AS total_count
        FROM
        group_buy_participant sub_gbp
        GROUP BY
        sub_gbp.group_buy_no
        ) total_participant ON gb.group_buy_no = total_participant.group_buy_no

        /* 수량 테이블 조인 (필요시) */
        LEFT JOIN
        quantity_group_buys qgb ON gb.group_buy_no = qgb.group_buy_no

        WHERE
        gb.creator_no = #{memberNo}
        <if test="filter != null and filter != 'ALL'">
            AND gb.status = #{filter}
        </if>

        ORDER BY
        gb.in_date DESC
    </select>


    <select id="getCreateGroupBuyList" parameterType="java.lang.Integer" resultType="com.oopsw.matna.vo.GroupBuyListVO">
        SELECT DISTINCT
            gb.group_buy_no groupBuyNo,
            gb.title,
            gb.status,
            gb.image_url imageUrl,
            gb.in_date inDate,
            gb.buy_end_date buyEndDate,
            gb.share_end_date shareEndDate,
            gb.buy_date buyDate,
            gb.arrival_date ArrivalDate,
            gbp.receive_date receiveDate,
            CASE
                WHEN qgb.my_quantity IS NOT NULL THEN
                    gb.quantity - (COALESCE(total_participant.total_qty, 0) + qgb.my_quantity)
                ELSE
                    0
                END AS remainingQuantity,
            qgb.my_quantity myQuantity,
            NULL AS participatedDate,
            NULL AS finalPaymentPoint,
            gbp.final_payment_point finalPaymentPoint,
            total_participant.total_count AS participantExMe,
            CASE
                WHEN gb.status != 'open' THEN
                    COALESCE(total_participant.total_settlement_point, 0)
                ELSE
                    0
                END AS totalSettlementPoint

        FROM
            group_buys gb
                LEFT JOIN
            group_buy_participant gbp ON gbp.group_buy_no = gb.group_buy_no
                LEFT JOIN
            (SELECT
                 sub_gbp.group_buy_no,
                 SUM(sub_gbp.my_quantity) AS total_qty,
                 COUNT(sub_gbp.participant_no) AS total_count,
                 SUM(sub_gbp.final_payment_point) AS total_settlement_point
             FROM
                 group_buy_participant sub_gbp
             GROUP BY
                 sub_gbp.group_buy_no
            ) total_participant ON gb.group_buy_no = total_participant.group_buy_no
                LEFT JOIN
            quantity_group_buys qgb ON gb.group_buy_no = qgb.group_buy_no

        WHERE
            gb.creator_no = #{creatorNo}
        ORDER BY
            gb.in_date DESC;
    </select>
</mapper>
