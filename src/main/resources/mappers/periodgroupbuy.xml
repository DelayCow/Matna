<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oopsw.matna.dao.PeriodGroupBuyDAO">

    <select id="selectGroupBuyListForHome" parameterType="map" resultType="com.oopsw.matna.vo.PeriodGroupBuyHomeVO">
        SELECT
        -- 1. title (String)
        gb.title,
        -- 2. nickname (String)
        m.nickname,
        -- 3. creatorImageUrl (String)
        m.image_url AS creatorImageUrl,
        -- 4. groupBuyImageUrl (String)
        gb.image_url AS groupBuyImageUrl,

        -- 5. inDate (LocalDateTime)
        gb.in_date AS inDate,

        -- 6. dueDate (LocalDateTime - DATETIME)
        pgb.due_date AS dueDate,

        -- 7. purchasePeriodDays (int - INTEGER)
        -- 이 필드에 DATETIME이 잘못 매핑되는 것을 방지합니다.
        gb.buy_end_date AS purchasePeriodDays,

        -- 8. finalPurchaseDeadline (LocalDateTime)
        DATE_ADD(pgb.due_date, INTERVAL gb.buy_end_date DAY) AS finalPurchaseDeadline,

        -- 9. minPricePerPerson (int)
        CEIL((gb.price * (1 + gb.fee_rate / 100)) / pgb.max_participants) AS minPricePerPerson,
        -- 10. maxPricePerPerson (int)
        CEIL((gb.price * (1 + gb.fee_rate / 100)) / 2) AS maxPricePerPerson,

        -- 11. shareLocation (String)
        gb.share_location AS shareLocation,

        -- (VO에 shareDetailAddress가 없으므로 생략)

        -- 12. participants (int)
        COUNT(gbp.group_buy_no) + 1 AS participants,
        -- 13. maxParticipants (int)
        pgb.max_participants AS maxParticipants,

        -- 14. groupBuyNo (Long/Integer)
        gb.group_buy_no AS groupBuyNo,
        -- 15. ingredientName (String)
        i.ingredient_name AS ingredientName,
        pgb.period_group_buy_no AS periodGroupBuyNo

        FROM
        GROUP_BUYS gb
        JOIN
        MEMBERS m ON m.member_no = gb.creator_no
        JOIN
        INGREDIENTS i ON i.ingredient_no = gb.ingredient_no
        JOIN
        PERIOD_GROUP_BUYS pgb ON pgb.group_buy_no = gb.group_buy_no
        LEFT JOIN
        GROUP_BUY_PARTICIPANT gbp ON gbp.group_buy_no = gb.group_buy_no AND gbp.cancel_date IS NULL AND gbp.participant_no != gb.creator_no
        WHERE
        gb.status = 'open'

        <!-- 검색어 조건 처리 (keyword 파라미터가 있을 경우) -->
        <if test="keyword != null and keyword != ''">
            AND (
            gb.title LIKE CONCAT('%', #{keyword}, '%')
            OR i.ingredient_name LIKE CONCAT('%', #{keyword}, '%')
            OR gb.share_location LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>

        GROUP BY
        gb.group_buy_no, gb.title, m.nickname, m.image_url, gb.image_url, gb.in_date,
        pgb.due_date, gb.buy_end_date, i.ingredient_name,
        gb.price, gb.fee_rate, pgb.max_participants, gb.share_location

        ORDER BY
        <choose>
            <!-- 1. 마감 임박순: 모집 마감일(pgb.due_date) 기준 오름차순 정렬 -->
            <when test="orderBy != null and orderBy == 'deadline'">
                pgb.due_date ASC, gb.in_date DESC
            </when>
            <!-- 2. 기본값: 최신 등록순 -->
            <otherwise>
                gb.in_date DESC
            </otherwise>
        </choose>
    </select>


    <update id="updateStatusToClosedIfDueDatePassed" parameterType="java.time.LocalDateTime">
        UPDATE
        GROUP_BUYS gb
        JOIN
        PERIOD_GROUP_BUYS pgb ON gb.group_buy_no = pgb.group_buy_no
        SET
        gb.status = 'closed'
        WHERE
        gb.status = 'open'
        AND pgb.due_date &lt; NOW()  <!-- MySQL 기준: pgb.due_date < NOW() -->
    </update>


    <select id="selectPeriodGroupBuyDetail" parameterType="int" resultType="com.oopsw.matna.vo.PeriodGroupBuyDetailVO">
        SELECT
            gb.group_buy_no AS groupBuyNo,
            gb.title,
            gb.content,
            gb.image_url AS imageUrl,
            gb.ingredient_no AS ingredientNo,
            pgb.max_participants,
            gb.fee_rate,
            gb.price,
            gb.quantity,
            gb.unit,
            gb.item_sale_url AS itemSaleUrl,

            -- PeriodGroupBuy의 PK 추가
            pgb.period_group_buy_no AS periodGroupBuyNo,

            -- 현재 참여 인원 계산: (creator_no가 아닌 취소되지 않은 참여자 수) + 1 (creator)
            COUNT(CASE WHEN gbp.participant_no != gb.creator_no THEN 1 END) + 1 AS participants,

            gb.in_date AS inDate,
            gb.share_location AS shareLocation,
            gb.share_detail_address AS shareDetailAddress,

            gb.buy_end_date AS purchasePeriodDays,
            gb.share_end_date AS shareEndDate,
            gb.share_time AS shareTime,

            -- 모집 마감일
            pgb.due_date AS dueDate,

            -- 모집 마감까지 남은 시간 (MySQL TIMESTAMPDIFF 함수 사용, 분 단위)
            TIMESTAMPDIFF(MINUTE, NOW(), pgb.due_date) AS remainingTime,

            gb.status,

            -- 개설자 정보
            m.image_url AS profileImageUrl,
            m.nickname
        FROM
            period_group_buys pgb
                INNER JOIN
            group_buys gb ON pgb.group_buy_no = gb.group_buy_no
                INNER JOIN
            members m ON gb.creator_no = m.member_no
                LEFT JOIN
            -- 취소되지 않은 참여자만 카운트 대상으로 포함
                group_buy_participant gbp ON gbp.group_buy_no = pgb.group_buy_no AND gbp.cancel_date IS NULL
        WHERE
            pgb.period_group_buy_no = #{periodGroupBuyNo}
        GROUP BY
            gb.group_buy_no, gb.title, gb.content, gb.image_url, gb.ingredient_no, pgb.max_participants, gb.fee_rate, gb.item_sale_url,
            gb.in_date, gb.share_location, gb.share_detail_address, gb.buy_end_date, gb.share_end_date, gb.status, m.image_url, m.nickname, pgb.due_date, pgb.period_group_buy_no
    </select>
</mapper>