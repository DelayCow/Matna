<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oopsw.matna.dao.QuantityGroupBuyDAO">

    <select id="selectQuantityGroupBuyHomeList" parameterType="map" resultType="com.oopsw.matna.vo.QuantityGroupBuyHomeVO">
        SELECT
        gb.group_buy_no AS groupBuyNo,
        gb.title,
        m.nickname,
        m.image_url AS creatorImageUrl,
        gb.image_url AS groupBuyImageUrl,
        gb.in_date AS inDate,
        i.ingredient_name AS ingredientName,

        gb.quantity AS quantity,
        qgb.my_quantity AS myQuantity,

        -- 남은 수량 (Integer): 총 수량 - (생성자 수량 + 참가자 총 수량)
        gb.quantity - (qgb.my_quantity + IFNULL(t1.totalParticipantQty, 0)) AS remainingQty,

        -- 남은 수량 비율 (Double): 남은 수량 / 전체 수량
        (gb.quantity - (qgb.my_quantity + IFNULL(t1.totalParticipantQty, 0))) / NULLIF(gb.quantity, 0) AS remainingRatio,

        qgb.price_per_unit AS pricePerUnit,
        qgb.share_amount AS shareAmount,
        gb.unit AS unit,

        gb.share_location AS shareLocation,
        qgb.quantity_group_buy_no AS quantityGroupBuyNo

        FROM
        group_buys gb
        JOIN
        members m ON m.member_no = gb.creator_no
        JOIN
        ingredients i ON i.ingredient_no = gb.ingredient_no
        JOIN
        quantity_group_buys qgb ON qgb.group_buy_no = gb.group_buy_no

        -- T1: 참가자 수량을 서브쿼리로 미리 합산하여 group_buy_no별 총합을 계산
        LEFT JOIN (
        SELECT
        group_buy_no,
        IFNULL(SUM(my_quantity), 0) AS totalParticipantQty
        FROM
        group_buy_participant
        WHERE
        cancel_date IS NULL
        GROUP BY
        group_buy_no
        ) t1 ON t1.group_buy_no = gb.group_buy_no

        WHERE
        gb.status = 'open'

        <if test="keyword != null and keyword != ''">
            AND (
            gb.title LIKE CONCAT('%', #{keyword}, '%')
            OR i.ingredient_name LIKE CONCAT('%', #{keyword}, '%')
            OR gb.share_location LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>

        ORDER BY
        <choose>
            <when test="orderBy != null and orderBy == 'dueSoon'">
                ((gb.quantity - (qgb.my_quantity + IFNULL(t1.totalParticipantQty, 0))) / NULLIF(gb.quantity, 0)) IS NULL ASC,
                ((gb.quantity - (qgb.my_quantity + IFNULL(t1.totalParticipantQty, 0))) / NULLIF(gb.quantity, 0)) ASC,
                gb.in_date DESC
            </when>
            <otherwise>
                gb.in_date DESC
            </otherwise>
        </choose>
    </select>

    <select id="selectQuantityGroupBuyDetail" parameterType="int" resultType="com.oopsw.matna.vo.QuantityGroupBuyDetailVO">
        SELECT
            gb.group_buy_no AS groupBuyNo,
            gb.creator_no AS creatorNo,
            gb.title,
            gb.content,
            gb.image_url AS imageUrl,
            gb.ingredient_no AS ingredientNo,
            gb.fee_rate AS feeRate,
            gb.item_sale_url AS itemSaleUrl,

            qgb.quantity_group_buy_no AS quantityGroupBuyNo,
            qgb.share_amount AS shareAmount,
            gb.unit AS unit,

            gb.in_date AS inDate,
            gb.share_location AS shareLocation,
            gb.share_detail_address AS shareDetailAddress,
            gb.buy_end_date AS buyEndDate,
            gb.share_end_date AS shareEndDate,
            gb.status AS status,

            qgb.price_per_unit AS pricePerUnit,

            -- 남은 수량 계산 (서브쿼리 사용)
            gb.quantity - (qgb.my_quantity + COALESCE(participant_sum.total_quantity, 0)) AS remainingQty,

            -- 생성자 정보
            m.image_url AS creatorProfileUrl,
            m.nickname AS creatorNickname

        FROM
            quantity_group_buys qgb
                INNER JOIN
            group_buys gb ON qgb.group_buy_no = gb.group_buy_no
                INNER JOIN
            members m ON gb.creator_no = m.member_no
                LEFT JOIN (
                SELECT
                    group_buy_no,
                    SUM(my_quantity) as total_quantity
                FROM
                    group_buy_participant
                WHERE
                    cancel_date IS NULL
                GROUP BY
                    group_buy_no
            ) participant_sum ON participant_sum.group_buy_no = gb.group_buy_no
        WHERE
            qgb.quantity_group_buy_no = #{quantityGroupBuyNo}
    </select>

</mapper>