<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oopsw.matna.dao.QuantityGroupBuyDAO">

    <select id="selectQuantityGroupBuyHomeList" parameterType="map" resultType="com.oopsw.matna.vo.QuantityGroupBuyHomeVO">
        SELECT
        gb.group_buy_no AS groupBuyNo,
        gb.title,
        m.nickname,
        m.image_url AS creatorImageUrl,
        gb.image_url AS groupBuyImageUrl,
        gb.in_date AS inDate,
        i.ingredient_name AS ingredientName,

        -- 수량 공구 특정 필드
        gb.quantity AS quantity,                     -- 총 수량
        gb.unit AS unit,                             -- 단위 (g, kg, 개 등)
        qgb.price_per_unit AS pricePerUnit,          -- 단위당 가격

        -- 남은 수량 계산: 총 수량 - (생성자 수량 + 참여자들 수량 합계)
        gb.quantity - (qgb.my_quantity + IFNULL(SUM(gbp.my_quantity), 0)) AS remainingQty,

        gb.share_location AS shareLocation

        FROM
        GROUP_BUYS gb
        JOIN
        MEMBERS m ON m.member_no = gb.creator_no
        JOIN
        INGREDIENTS i ON i.ingredient_no = gb.ingredient_no
        JOIN
        QUANTITY_GROUP_BUYS qgb ON qgb.group_buy_no = gb.group_buy_no <!-- 수량 공구 테이블 조인 -->
        LEFT JOIN
        -- 취소되지 않은 참여자의 수량만 합산
        GROUP_BUY_PARTICIPANT gbp ON gbp.group_buy_no = gb.group_buy_no AND gbp.cancel_date IS NULL
        WHERE
        gb.status = 'OPEN' -- 현재 모집 중인 공구만 조회

        <!-- 검색어 조건 처리 (keyword 파라미터가 있을 경우) -->
        <if test="keyword != null and keyword != ''">
            AND (
            gb.title LIKE CONCAT('%', #{keyword}, '%')
            OR i.ingredient_name LIKE CONCAT('%', #{keyword}, '%')
            OR gb.share_location LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>

        GROUP BY
        gb.group_buy_no, gb.title, m.nickname, m.image_url, gb.image_url, gb.in_date,
        i.ingredient_name, gb.quantity, gb.unit, qgb.price_per_unit, qgb.my_quantity,
        gb.share_location

        ORDER BY
        <choose>
            <!-- 1. 남은 수량 적은 순: 마감 임박에 준하는 정렬 (remainingQty 기준 오름차순) -->
            <when test="orderBy != null and orderBy == 'remaining'">
                remainingQty ASC, gb.in_date DESC
            </when>
            <!-- 2. 기본값: 최신 등록순 -->
            <otherwise>
                gb.in_date DESC
            </otherwise>
        </choose>
    </select>
</mapper>