<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oopsw.matna.repository.ReportDAO">
    <select id="getReports" resultType="com.oopsw.matna.vo.AllReportVO">
        SELECT
            rt.report_no      AS reportNo,
            m.member_id       AS memberId,
            m.nickname        AS nickname,
            rt.reported_date  AS reportedDate,
            rt.status         AS status,
            rt.reason         AS reason,
            CASE
                WHEN gbr.report_no IS NOT NULL THEN 'group_buys'
                WHEN mr.report_no IS NOT NULL THEN 'members'
                ELSE 'error'
                END                AS reportCase
        FROM
            REPORTS rt
        JOIN members m ON m.member_no = rt.reporter_no
        LEFT JOIN
            MEMBER_REPORTS mr ON rt.report_no = mr.report_no
        LEFT JOIN
            GROUP_BUY_REPORTS gbr ON rt.report_no = gbr.report_no
        <where>
            <if test="startDate != null and endDate != null">
                rt.reported_date between #{startDate} and #{endDate}
            </if>
            <if test="reportStatus != null">
                and rt.status = #{reportStatus}
            </if>
            <if test="reportCase == 'members'">
                AND mr.report_no IS NOT NULL
            </if>
            <if test="reportCase == 'group_buys'">
                AND gbr.report_no IS NOT NULL
            </if>
            <if test="(memberId != null and memberId != '')
          or (nickname != null and nickname != '')">
                AND (
                (#{memberId} != '' AND m.member_id = #{memberId})
                OR
                (#{nickname} != '' AND m.nickname = #{nickname})
                )
            </if>
        </where>
    </select>
</mapper>