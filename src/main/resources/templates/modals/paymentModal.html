<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <style>
    /* 결제 모달 전용 스타일 */
    #paymentModal .modal-dialog {
      max-width: 420px;
    }

    #paymentModal .modal-header {
      border-bottom: none;
      padding: 20px 24px 10px;
    }

    #paymentModal .modal-body {
      padding: 10px 24px 24px;
    }

    #paymentModal .modal-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    #paymentModal .btn-close {
      font-size: 24px;
      padding: 0;
      margin: 0;
    }

    .payment-receipt {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      background-color: #fafafa;
      margin-bottom: 20px;
    }

    .receipt-header {
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 12px;
      color: #333;
    }

    .receipt-body {
      font-size: 12px;
      line-height: 1.8;
      color: #666;
    }

    .receipt-row {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
    }

    .receipt-row.total {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #ddd;
      font-weight: 600;
      color: #333;
    }

    .receipt-amount {
      color: #ff6b35;
      font-weight: 600;
    }

    .image-upload-area {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background-color: #fafafa;
      margin-bottom: 16px;
    }

    .image-upload-area:hover {
      border-color: #ff6b35;
      background-color: #fff5f2;
    }

    .image-upload-area.has-image {
      padding: 0;
      border: 1px solid #e0e0e0;
    }

    .upload-icon {
      font-size: 48px;
      color: #ccc;
      margin-bottom: 12px;
    }

    .upload-text {
      font-size: 14px;
      color: #666;
      margin-bottom: 4px;
    }

    .upload-hint {
      font-size: 12px;
      color: #999;
    }

    .preview-image {
      width: 100%;
      height: auto;
      border-radius: 8px;
      display: none;
    }

    .preview-image.show {
      display: block;
    }

    .form-label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .form-control {
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 10px 12px;
      font-size: 14px;
    }

    .form-control:focus {
      border-color: #ff6b35;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    .btn-register {
      width: 100%;
      background-color: #ff6b35;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      margin-top: 16px;
    }

    .btn-register:hover {
      background-color: #e55a2b;
    }

    .input-group-text {
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      color: #666;
    }
  </style>
</head>
<body>

<!-- 결제 정보 등록 모달 Fragment -->
<div th:fragment="paymentModal" class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">결제 영수증</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">×</button>
      </div>
      <div class="modal-body">
        <form id="paymentForm">
          <input type="hidden" id="paymentProductId" name="productId">

          <!-- 결제 영수증 미리보기 -->
          <div class="payment-receipt">
            <div class="receipt-header">결제 정보</div>
            <div class="receipt-body">
              <div class="receipt-row">
                <span>상품명</span>
                <span id="receiptProductName">표고버섯 500g</span>
              </div>
              <div class="receipt-row">
                <span>수량</span>
                <span id="receiptAmount">100g</span>
              </div>
              <div class="receipt-row">
                <span>단가</span>
                <span id="receiptUnitPrice">50원/g</span>
              </div>
              <div class="receipt-row total">
                <span>총 결제금액</span>
                <span class="receipt-amount" id="receiptTotalPrice">5,000원</span>
              </div>
            </div>
          </div>

          <!-- 영수증 이미지 업로드 -->
          <div class="mb-3">
            <label class="form-label">결제 영수증</label>
            <input type="file" id="receiptImageInput" name="receiptImage"
                   accept="image/*" style="display: none;">
            <div class="image-upload-area" id="uploadArea" onclick="document.getElementById('receiptImageInput').click();">
              <div id="uploadPlaceholder">
                <div class="upload-icon">+</div>
                <div class="upload-text">영수증 이미지를 업로드하세요</div>
                <div class="upload-hint">JPG, PNG 파일 (최대 5MB)</div>
              </div>
              <img id="previewImage" class="preview-image" alt="영수증 미리보기">
            </div>
          </div>

          <!-- 구매날짜 -->
          <div class="mb-3">
            <label class="form-label">구매날짜</label>
            <div class="input-group">
              <input type="date" class="form-control" name="purchaseDate"
                     id="purchaseDate" required>
              <span class="input-group-text">
                                <i class="bi bi-calendar"></i>
                            </span>
            </div>
          </div>

          <!-- 추가상명 (선택) -->
          <div class="mb-3">
            <label class="form-label">추가상명 <small class="text-muted">(선택)</small></label>
            <input type="text" class="form-control" name="additionalName"
                   placeholder="추가 설명이 있다면 입력하세요">
          </div>

          <!-- 등록하기 버튼 -->
          <button type="button" class="btn btn-register" onclick="submitPaymentInfo()">
            등록하기
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script th:fragment="paymentScript">
  // 결제 모달 열기
  function openPaymentModal(productId, productName, amount, unitPrice) {
    document.getElementById('paymentProductId').value = productId;

    // 영수증 정보 업데이트
    document.getElementById('receiptProductName').textContent = productName;
    document.getElementById('receiptAmount').textContent = amount;
    document.getElementById('receiptUnitPrice').textContent = unitPrice;

    // 총 금액 계산 (예시)
    const amountNum = parseInt(amount.replace(/[^0-9]/g, ''));
    const priceNum = parseInt(unitPrice.replace(/[^0-9]/g, ''));
    const total = (amountNum * priceNum).toLocaleString();
    document.getElementById('receiptTotalPrice').textContent = total + '원';

    // 오늘 날짜를 기본값으로 설정
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('purchaseDate').value = today;

    // 이미지 미리보기 초기화
    document.getElementById('previewImage').classList.remove('show');
    document.getElementById('uploadPlaceholder').style.display = 'block';
    document.getElementById('uploadArea').classList.remove('has-image');
    document.getElementById('receiptImageInput').value = '';

    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
  }

  // 이미지 미리보기
  document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.getElementById('receiptImageInput');
    if (imageInput) {
      imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          // 파일 크기 체크 (5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('파일 크기는 5MB 이하여야 합니다.');
            this.value = '';
            return;
          }

          // 이미지 파일 체크
          if (!file.type.startsWith('image/')) {
            alert('이미지 파일만 업로드 가능합니다.');
            this.value = '';
            return;
          }

          // 미리보기 표시
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('previewImage');
            const placeholder = document.getElementById('uploadPlaceholder');
            const uploadArea = document.getElementById('uploadArea');

            preview.src = e.target.result;
            preview.classList.add('show');
            placeholder.style.display = 'none';
            uploadArea.classList.add('has-image');
          };
          reader.readAsDataURL(file);
        }
      });
    }
  });

  // 결제 정보 제출
  function submitPaymentInfo() {
    const form = document.getElementById('paymentForm');
    const imageInput = document.getElementById('receiptImageInput');
    const purchaseDate = document.getElementById('purchaseDate').value;

    // 유효성 검사
    if (!imageInput.files || imageInput.files.length === 0) {
      alert('영수증 이미지를 업로드해주세요.');
      return;
    }

    if (!purchaseDate) {
      alert('구매날짜를 선택해주세요.');
      return;
    }

    const formData = new FormData(form);

    // 로딩 표시 (선택사항)
    const submitBtn = event.target;
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '등록 중...';

    fetch('/api/group-buy/payment-info', {
      method: 'POST',
      body: formData
    })
            .then(response => response.json())
            .then(data => {
              alert('결제 정보가 등록되었습니다.');
              bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
              location.reload();
            })
            .catch(error => {
              alert('등록 중 오류가 발생했습니다.');
              console.error(error);
            })
            .finally(() => {
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
            });
  }
</script>

</body>
</html>